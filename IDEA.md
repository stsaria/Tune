# Tune P2P Network Protocol 仕様書

## 概要

Tuneは、UDPベースのP2Pネットワークプロトコルを使用した分散型メッセージングシステムです。ノード間でメッセージを交換し、リプライ機能を持つ階層的なチャットシステムを提供します。

## 前提条件

- ノードは「A、B、C、D、E...」と続くものとする
- 各ノードのIPアドレスはある程度ランダムに分散している
- 全ノードは最低限、上り・下りともに1Mbpsの通信速度を持つ
- 致命的な接続失敗がない限り、全ノードが均等に処理を実行し、ネットワークから離脱しない
- 最大ノード数は75ノード（設定可能）

## ノード間の接続方法

- UDP通信を使用
- ポート範囲: 1024-65535（自動選択）

## ID形式

### エンコード
- Base64でエンコードされたJSON形式

### 構造
```json
{
  "node": ["IPアドレス", "ポート番号"]
}
```

### 例
```json
{
  "node": ["142.95.104.10", "14952"]
}
```

**注意:** クライアントは迷惑パケットの大量送信を防ぐため、複数のリクエストがある場合は一部を無視する場合がある。

## ネットワークへの参加（ノード開始）

### 手順

1. **ノード初期化**
   - Ed25519鍵ペアの生成
   - ランダムポートの選択（1024-65535）
   - ノード名の設定

2. **初期ノードへの接続**
   - 初期ノードIDを指定して接続
   - Hello交換による相互認証

3. **ノード情報の同期**
   - 接続先ノードから不足しているノード情報を受信
   - 最大13ノードのランダムサンプルを取得
   - 古いIDファイルでも問題なくネットワーク参加が可能

4. **定期的な同期**
   - 全ノードが40秒間隔で同期処理を実行
   - ping/pongでノードの生存確認を実施
   - 接続できないノードは自動的に削除

*各ノードが今の時点で、人が多すぎると判断した場合には、ノード情報を返してくれなかったりする可能性はあります。

## 通信プロトコル

### メッセージ形式
```json
{
  "t": 通信タイプ,
  "d": データ,
  "id": レスポンスID
}
```

### 通信タイプ（CommuType）
- `HELLO = 0`: ノード間の初期認証
- `RESPONSE = 1`: レスポンス
- `PING = 2`: 生存確認
- `GET_NODES = 100`: ノード一覧取得
- `GET_RAND_MESSAGE = 101`: ランダムメッセージ取得
- `GET_MESSAGE = 102`: 特定メッセージ取得
- `GET_MY_IP_AND_PORT = 103`: 自分のIP:Port取得

### エラーコード
- `LOC_TIME_OUTED = 200`: タイムアウト
- `LOC_ERROR = 201`: ローカルエラー
- `ERR_I_DONT_KNOW_YOUR_REQ_TYPE = 300`: 不明なリクエストタイプ

## メッセージ処理

### 投稿

#### 通常の投稿（RootMessage）
```json
{
  "c": "メッセージ内容",
  "ts": タイムスタンプ,
  "hash": "SHA256ハッシュ値(content+timestamp)",
  "sig": "デジタル署名"
}
```

**処理:**
1. メッセージ内容を作成し、自分のノードに保存
2. 内容とタイムスタンプを合わせたSHA256ハッシュを生成
3. ハッシュに対するEd25519デジタル署名を追加

#### リプライ投稿（ReplyMessage）
```json
{
  "c": "メッセージ内容",
  "ts": タイムスタンプ,
  "from": "リプライ元のIP:Port",
  "fromPub": "リプライ元の公開鍵",
  "fromHash": "リプライ元ハッシュ",
  "hash": "SHA256ハッシュ値(content+timestamp+fromHash)",
  "sig": "デジタル署名"
}
```

### 受信・処理

#### 処理手順

1. **メッセージ取得**
   - 各ノードから最大16メッセージをリクエスト

2. **初期分類**
   - 全メッセージを単一リスト（リストA）に格納
   - `from`属性のないメッセージのみを抽出し、新しいリスト（リストB）に格納

3. **階層構造の構築**
   - リストBの各メッセージに対して再帰関数を実行
   - `fromHash`が一致するメッセージを該当メッセージの配下に配置
   - 処理済みメッセージはリストAから除外

4. **継続処理**
   - リプライが発見された場合、さらに処理を継続
   - リストBが大きくなりすぎた場合は処理を中断する場合あり

5. **未解決リプライの処理**
   - 処理が完了してもリストAに`from`付きメッセージが残っている場合
   - `from`に記載された公開鍵から接続済みリストでホストを検索
   - 該当ホストに`fromHash`を送信してメッセージを取得
   - 取得したメッセージも`from`付きの場合は再帰的に処理継続

6. **エラーハンドリング**
   - `from`探索時点で処理が中断された場合は「不明なリプライ元」として扱う

7. **出力**
   - 処理完了後、UIなどに結果を出力

## セキュリティ・署名

### 署名アルゴリズム
- **必須:** Ed25519デジタル署名アルゴリズムを使用

### Hello交換
#### Hello送信
```json
{
  "t": 0,
  "d": {
    "name": "ユーザー名",
    "pub": "Ed25519公開鍵（16進数）"
  },
  "id": "レスポンスID"
}
```

#### Hello応答
```json
{
  "t": 1,
  "d": {
    "name": "ユーザー名",
    "pub": "Ed25519公開鍵（16進数）"
  },
  "id": "レスポンスID"
}
```

### 認証方式
- メッセージの署名フィールド（`sig`）にEd25519署名を格納
- **重要:** 公開鍵をユーザー識別子として使用する
  - 理由: 証明書が存在せず、特定のホストとの紐付けができないため
  - 公開鍵が実質的なユーザー名となる
- Hello受信時は必ず応答を返す

## ノード管理

### ノード登録
- 最大75ノードまで登録可能（設定変更可能）
- 重複チェック: IP:Portと公開鍵の両方で重複を防止
- 自動削除: 接続できないノードは自動的に削除

### BAN機能
- IPアドレスベースのBAN
- ノードIDベースのBAN
- BANされたノードからのメッセージは自動削除

### メッセージ管理
- 最大1000メッセージ保持
- リプライ比率制限: 1/3
- 最小メッセージサイズ: 10文字
- メッセージ有効期限: 3時間

## GUI機能

### タブ形式インターフェース
1. **基本設定タブ**
   - ノード名設定
   - 最大ノード数設定
   - ノード開始/停止

2. **ノード管理タブ**
   - 初期ノード追加
   - ノード一覧表示
   - BAN機能

3. **メッセージタブ**
   - メッセージ送信
   - メッセージ一覧表示

4. **ログタブ**
   - システムログ表示
   - ログクリア/保存機能

### リアルタイム更新
- 2秒間隔でノード情報とメッセージを更新
- ノード状態のリアルタイム表示
- ログの自動スクロール